# k8s/config/db-schemas-exch-us-equities-global-data.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: db-schemas-exch-us-equities-global-data
data:
  exch-us-equities-global-data.sql: |
    -- global_schema.sql
    -- OpenTP Exchange Service Database Schema - Global Data Tables

    -- =====================================================================================
    -- UNIVERSE DATA TABLE
    -- =====================================================================================
    CREATE TABLE IF NOT EXISTS exch_us_equity.universe_data (
        date DATE NOT NULL,
        symbol VARCHAR(20) NOT NULL,
        sector VARCHAR(100),
        industry VARCHAR(100),
        market_cap BIGINT,
        country VARCHAR(2),
        currency VARCHAR(3) NOT NULL,
        avg_daily_volume BIGINT,
        beta DECIMAL(10,4),
        primary_exchange VARCHAR(10),
        shares_outstanding BIGINT
    );

    CREATE INDEX idx_universe_data_date ON exch_us_equity.universe_data(date);
    CREATE INDEX idx_universe_data_symbol ON exch_us_equity.universe_data(symbol);
    CREATE UNIQUE INDEX idx_universe_data_unique ON exch_us_equity.universe_data(date, symbol);

    -- =====================================================================================
    -- RISK DATA TABLE (FACTOR MODEL)
    -- =====================================================================================
    CREATE TABLE IF NOT EXISTS exch_us_equity.risk_factor_data (
        date DATE NOT NULL,
        model VARCHAR(20) NOT NULL,
        factor1 VARCHAR(20) NOT NULL,
        factor2 VARCHAR(20) NOT NULL,
        factor3 VARCHAR(20) NOT NULL,
        symbol VARCHAR(20) NOT NULL,
        type VARCHAR(100),
        name VARCHAR(100),
        value DECIMAL(12,6)
    );

    CREATE INDEX idx_risk_factor_data_date ON exch_us_equity.risk_factor_data(date);
    CREATE INDEX idx_risk_factor_data_model_symbol ON exch_us_equity.risk_factor_data(model, symbol);
    CREATE UNIQUE INDEX idx_risk_factor_data_unique ON exch_us_equity.risk_factor_data(date, model, symbol, type, name);

    -- =====================================================================================
    -- GRANT PERMISSIONS
    -- =====================================================================================
    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA exch_us_equity TO opentp;
    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA exch_us_equity TO opentp;

    -- Print success message
    SELECT 'Global data schema created successfully!' as status;